"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.renderOption=renderOption,exports.renderOptgroup=renderOptgroup,exports.default=void 0;var _input=_interopRequireDefault(require("../../input/src/input")),_conf=_interopRequireDefault(require("../../conf")),_util=require("./util"),_tools=require("../../tools");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function findOffsetOption(t,e,i){for(var n,o,l=!1,s=0;s<t.length;s++){var a=t[s];if(a.options)for(var r=0;r<a.options.length;r++){var p=a.options[r];if(o=o||p,i){if(e===p.value)return{offsetOption:n,firstOption:o}}else{if(l)return{offsetOption:p,firstOption:o};e===p.value&&(l=!0)}n=p}else{if(o=o||a,i){if(e===a.value)return{offsetOption:n,firstOption:o}}else{if(l)return{offsetOption:a,firstOption:o};e===a.value&&(l=!0)}n=a}}return{firstOption:o}}function findOption(t,e){for(var i=0;i<t.length;i++){var n=t[i];if(n.options)for(var o=0;o<n.options.length;o++){var l=n.options[o];if(e===l.value)return l}else if(e===n.value)return n}}function renderOption(l,s,t,a){var r=s.optkey,p=s.value,u=s.currentValue,e=s.optionGroupProps,i=void 0===e?{}:e,n=s.optionProps,o=void 0===n?{}:n,d=i.disabled||"disabled",f=o.label||"label",h=o.value||"value",c=o.disabled||"disabled";return t?t.map(function(t,e){var i=a&&a[d]||t[c],n=t[h],o=(0,_util.getOptid)(s,t);return l("div",{key:r?o:e,class:["vxe-select-option",{"is--disabled":i,"is--checked":p===n,"is--hover":u===n}],attrs:{"data-optid":o},on:{click:function(t){i||s.changeOptionEvent(t,n)},mouseenter:function(){i||s.setCurrentOption({value:n})}}},_tools.UtilTools.formatText(_tools.UtilTools.getFuncText(t[f])))}):[]}function renderOptgroup(n,o){var l=o.optkey,t=o.optionGroups,e=o.optionGroupProps,i=void 0===e?{}:e,s=i.options||"options",a=i.label||"label",r=i.disabled||"disabled";return t?t.map(function(t,e){var i=(0,_util.getOptid)(o,t);return n("div",{key:l?i:e,class:["vxe-optgroup",{"is--disabled":t[r]}],attrs:{"data-optid":i}},[n("div",{class:"vxe-optgroup--title"},_tools.UtilTools.getFuncText(t[a])),n("div",{class:"vxe-optgroup--wrapper"},renderOption(n,o,t[s],t))])}):[]}var _default2={name:"VxeSelect",props:{value:null,clearable:Boolean,placeholder:String,disabled:Boolean,prefixIcon:String,placement:String,options:Array,optionProps:Object,optionGroups:Array,optionGroupProps:Object,size:{type:String,default:function(){return _conf.default.select.size||_conf.default.size}},optId:{type:String,default:function(){return _conf.default.select.optId}},optKey:Boolean,transfer:{type:Boolean,default:function(){return _conf.default.select.transfer}}},components:{VxeInput:_input.default},provide:function(){return{$xeselect:this}},data:function(){return{updateFlag:0,panelIndex:0,optionList:[],allOptList:[],panelStyle:null,panelPlacement:null,currentValue:null,visiblePanel:!1,animatVisible:!1,isActivated:!1}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},selectLabel:function(){var t=findOption(this.allOptList,this.value);return t?t.label:this.value}},watch:{options:function(){this.updateCache(),this.updateOptComps()},optionGroups:function(){this.updateCache(),this.updateOptComps()},updateFlag:function(){this.updateOptComps()}},created:function(){(this.options||this.optionGroups)&&(this.updateCache(),this.updateOptComps()),_tools.GlobalEvent.on(this,"syncwheel",this.handleSyncwheelEvent),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"keydown",this.handleGlobalKeydownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},mounted:function(){this.transfer&&document.body.appendChild(this.$refs.panel)},beforeDestroy:function(){var t=this.$refs.panel;t&&t.parentNode&&t.parentNode.removeChild(t)},destroyed:function(){_tools.GlobalEvent.off(this,"syncwheel"),_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"keydown"),_tools.GlobalEvent.off(this,"blur")},render:function(t){var e,i,n=this.vSize,o=this.transfer,l=this.isActivated,s=this.disabled,a=this.clearable,r=this.placeholder,p=this.selectLabel,u=this.animatVisible,d=this.visiblePanel,f=this.panelStyle,h=this.prefixIcon,c=this.panelPlacement,v=this.optionGroups;return t("div",{class:["vxe-select",(_defineProperty(e={},"size--".concat(n),n),_defineProperty(e,"is--visivle",d),_defineProperty(e,"is--disabled",s),_defineProperty(e,"is--active",l),e)]},[t("vxe-input",{ref:"input",props:{clearable:a,placeholder:r,readonly:!0,disabled:s,type:"text",prefixIcon:h,suffixIcon:d?_conf.default.icon.SELECT_OPEN:_conf.default.icon.SELECT_CLOSE,value:p},on:{clear:this.clearEvent,click:this.togglePanelEvent,focus:this.focusEvent,blur:this.blurEvent,"suffix-click":this.togglePanelEvent}}),t("div",{ref:"panel",class:["vxe-dropdown--panel vxe-select--panel",(_defineProperty(i={},"size--".concat(n),n),_defineProperty(i,"is--transfer",o),_defineProperty(i,"animat--leave",u),_defineProperty(i,"animat--enter",d),i)],attrs:{"data-placement":c},style:f},[t("div",{ref:"optWrapper",class:"vxe-select-option--wrapper"},this.$slots.default||(v?renderOptgroup(t,this):renderOption(t,this,this.options)))])])},methods:{updateOptions:function(){this.updateFlag++},updateCache:function(){var e=this,t=this.options,i=this.optionGroups,n=this.optionGroupProps,o=(void 0===n?{}:n).options||"options";if(i||t){var l=(0,_util.getOptkey)(this),s=function(t){(0,_util.getOptid)(e,t)||(t[l]=(0,_util.getOptUniqueId)())};i?i.forEach(function(t){s(t),t[o]&&t[o].forEach(s)}):t.forEach(s)}},updateOptComps:function(){var s=this,t=this.options,e=this.optionGroups,a=[],r=[];if(e||t){var i=this.optionProps,n=void 0===i?{}:i,o=this.optionGroupProps,l=void 0===o?{}:o,p=n.disabled||"disabled",u=n.label||"label",d=n.value||"value";if(e){var f=l.options||"options",h=l.label||"label",c=l.disabled||"disabled";e.forEach(function(n){var o=[],l=[];n[f].forEach(function(t){var e=n&&n[c]||t[p],i={label:t[u],value:t[d],disabled:e,id:(0,_util.getOptid)(s,t)};e||o.push(i),l.push(i)}),o.length&&a.push({label:n[h],disabled:n[c],options:o,id:(0,_util.getOptid)(s,n)}),l.length&&r.push({label:n[h],disabled:n[c],options:l,id:(0,_util.getOptid)(s,n)})})}else t.forEach(function(t){var e=t[p],i={label:t[u],value:t[d],disabled:e,id:(0,_util.getOptid)(s,t)};e||a.push(i),r.push(i)});return this.optionList=a,this.allOptList=r,Promise.resolve()}return this.$nextTick().then(function(){s.$children.forEach(function(t){if(t.$xeselect){var i=[],n=[],e=t.$children.length;if(t.$children.forEach(function(t){if(t.$xeselect&&t.$xeoptgroup){var e={label:t.label,value:t.value,disabled:t.isDisabled,id:t.id};t.isDisabled||i.push(e),n.push(e)}}),e)i.length&&a.push({label:t.label,disabled:t.disabled,options:i,id:t.id}),n.length&&r.push({label:t.label,disabled:t.disabled,options:n,id:t.id});else{var o={label:t.label,value:t.value,disabled:t.disabled,id:t.id};t.disabled||a.push(o),r.push(o)}}}),s.optionList=a,s.allOptList=r})},setCurrentOption:function(t){t&&(this.currentValue=t.value)},scrollToOption:function(l,s){var a=this;return new Promise(function(o){if(l)return a.$nextTick().then(function(){var t=a.$refs,e=t.optWrapper,i=t.panel.querySelector("[data-optid='".concat(l.id,"']"));if(e&&i){var n=e.offsetHeight;s?i.offsetTop+i.offsetHeight-e.scrollTop>n&&(e.scrollTop=i.offsetTop+i.offsetHeight-n):i.offsetTop-5<e.scrollTop&&(e.scrollTop=i.offsetTop-5)}o()});o()})},clearEvent:function(t,e){this.clearValueEvent(e,null),this.hideOptionPanel()},clearValueEvent:function(t,e){this.changeEvent(t,e),this.$emit("clear",{value:e,$event:t})},changeEvent:function(t,e){e!==this.value&&(this.$emit("input",e),this.$emit("change",{value:e,$event:t}))},changeOptionEvent:function(t,e){this.changeEvent(t,e),this.hideOptionPanel()},handleSyncwheelEvent:function(t){var e=this.$refs,i=this.$el,n=this.disabled,o=this.visiblePanel;if(!n&&o){var l=_tools.DomTools.getEventTargetNode(t,i).flag;l||_tools.DomTools.getEventTargetNode(t,e.panel).flag?l&&this.updatePlacement():this.hideOptionPanel()}},handleGlobalMousedownEvent:function(t){var e=this.$refs,i=this.$el,n=this.disabled,o=this.visiblePanel;n||(this.isActivated=_tools.DomTools.getEventTargetNode(t,i).flag||_tools.DomTools.getEventTargetNode(t,e.panel).flag,o&&!this.isActivated&&this.hideOptionPanel())},handleGlobalKeydownEvent:function(t){var e=this.visiblePanel,i=this.currentValue,n=this.clearable;if(!this.disabled){var o=t.keyCode,l=9===o,s=13===o,a=27===o,r=38===o,p=40===o,u=46===o,d=32===o;if(l&&(this.isActivated=!1),e)if(a||l)this.hideOptionPanel();else if(s)this.changeOptionEvent(t,i);else if(r||p){t.preventDefault();var f=this.optionList,h=findOffsetOption(f,i,r),c=h.offsetOption,v=h.firstOption;c||findOption(f,i)||(c=v),this.setCurrentOption(c),this.scrollToOption(c,p)}else d&&t.preventDefault();else(r||p||s||d)&&this.isActivated&&(t.preventDefault(),this.showOptionPanel());this.isActivated&&u&&n&&this.clearValueEvent(t,null)}},handleGlobalBlurEvent:function(){this.hideOptionPanel()},updateZindex:function(){this.panelIndex<_tools.UtilTools.getLastZIndex()&&(this.panelIndex=_tools.UtilTools.nextZIndex())},focusEvent:function(){this.disabled||(this.isActivated=!0)},blurEvent:function(){this.isActivated=!1},togglePanelEvent:function(t){t.$event.preventDefault(),this.visiblePanel?this.hideOptionPanel():this.showOptionPanel()},showOptionPanel:function(){var e=this;this.disabled||(clearTimeout(this.hidePanelTimeout),this.isActivated=!0,this.animatVisible=!0,setTimeout(function(){var t=findOption(e.allOptList,e.value);e.visiblePanel=!0,t&&(e.setCurrentOption(t),e.scrollToOption(t))},10),this.updateZindex(),this.updatePlacement())},hideOptionPanel:function(){var t=this;this.visiblePanel=!1,this.hidePanelTimeout=setTimeout(function(){t.animatVisible=!1},200)},updatePlacement:function(){var O=this;this.$nextTick(function(){var t=O.$refs,e=O.transfer,i=O.placement,n=O.panelIndex,o=t.input.$el,l=t.panel,s=o.offsetHeight,a=o.offsetWidth,r=l.offsetHeight,p={zIndex:n},u=_tools.DomTools.getAbsolutePos(o),d=u.boundingTop,f=u.boundingLeft,h=u.visibleHeight,c="bottom";if(e){var v=f,b=d+s;"top"===i?(c="top",b=d-r):(h<b+r&&(c="top",b=d-r),b<0&&(c="bottom",b=d+s)),Object.assign(p,{left:"".concat(v,"px"),top:"".concat(b,"px"),minWidth:"".concat(a,"px")})}else"top"===i?(c="top",p.bottom="".concat(s,"px")):h<d+s+r&&(c="top",p.bottom="".concat(s,"px"));O.panelStyle=p,O.panelPlacement=c})},focus:function(){return this.showOptionPanel(),this.$nextTick()},blur:function(){return this.hideOptionPanel(),this.$nextTick()}}};exports.default=_default2;