"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function renderBtns(h,f){var v=f._e,t=f.$scopedSlots,d=f.$xegrid,m=f.$xetable,e=f.buttons,o=void 0===e?[]:e;return t.buttons?t.buttons.call(f,{$grid:d,$table:m},h):o.map(function(e){var t=e.name,o=e.visible,s=e.icon,i=e.type,n=e.status,l=e.disabled,r=e.loading,c=e.dropdowns,a=e.buttonRender,u=a?_vXETable.default.renderer.get(a.name):null;return!1===o?v():u&&u.renderButton?h("span",{class:"vxe-button--item"},u.renderButton.call(f,h,a,{$grid:d,$table:m,button:e},{$grid:d,$table:m})):h("vxe-button",{on:{click:function(t){return f.btnEvent(t,e)}},props:{icon:s,type:i,status:n,disabled:l,loading:r},scopedSlots:c&&c.length?{default:function(){return _tools.UtilTools.getFuncText(t)},dropdowns:function(){return c.map(function(e){return!1===e.visible?v():h("vxe-button",{on:{click:function(t){return f.btnEvent(t,e)}},props:{icon:e.icon,type:e.type,disabled:e.disabled,loading:e.loading}},_tools.UtilTools.getFuncText(e.name))})}}:null},_tools.UtilTools.getFuncText(t))})}function renderRightTools(t,e){var o=e.$scopedSlots,s=e.$xegrid,i=e.$xetable;return o.tools?o.tools.call(e,{$grid:s,$table:i},t):[]}function renderCustoms(n,l){var t=l.$xetable,e=l.customStore,o=l.customOpts,s=l.collectColumn,r=[],i={},c={},a=(t&&t.customOpts?t.customOpts.checkMethod:null)||o.checkMethod;return"manual"===o.trigger||("hover"===o.trigger?(i.mouseenter=l.handleMouseenterSettingEvent,i.mouseleave=l.handleMouseleaveSettingEvent,c.mouseenter=l.handleWrapperMouseenterEvent,c.mouseleave=l.handleWrapperMouseleaveEvent):i.click=l.handleClickSettingEvent),_xeUtils.default.eachTree(s,function(t){var e=_tools.UtilTools.formatText(t.getTitle(),1),o=t.getKey(),s=t.children&&t.children.length,i=!!a&&!a({column:t});(s||o)&&r.push(n("li",{class:["vxe-custom--option","level--".concat(t.level),{"is--group":s,"is--checked":t.visible,"is--indeterminate":t.halfVisible,"is--disabled":i}],attrs:{title:e},on:{click:function(){i||l.changeCustomOption(t)}}},[n("span",{class:"vxe-checkbox--icon vxe-checkbox--checked-icon"}),n("span",{class:"vxe-checkbox--icon vxe-checkbox--unchecked-icon"}),n("span",{class:"vxe-checkbox--icon vxe-checkbox--indeterminate-icon"}),n("span",{class:"vxe-checkbox--label"},e)]))}),n("div",{class:["vxe-custom--wrapper",{"is--active":e.visible}],ref:"customWrapper"},[n("div",{class:"vxe-tools--operate-btn vxe-tools--operate-custom-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.custom")},on:i},[n("i",{class:o.icon||_conf.default.icon.TOOLBAR_TOOLS_CUSTOM})]),n("div",{class:"vxe-custom--option-wrapper"},[n("ul",{class:"vxe-custom--header"},[n("li",{class:["vxe-custom--option",{"is--checked":e.isAll,"is--indeterminate":e.isIndeterminate}],attrs:{title:_conf.default.i18n("vxe.table.allTitle")},on:{click:l.allCustomEvent}},[n("span",{class:"vxe-checkbox--icon vxe-checkbox--checked-icon"}),n("span",{class:"vxe-checkbox--icon vxe-checkbox--unchecked-icon"}),n("span",{class:"vxe-checkbox--icon vxe-checkbox--indeterminate-icon"}),n("span",{class:"vxe-checkbox--label"},_conf.default.i18n("vxe.toolbar.customAll"))])]),n("ul",{class:"vxe-custom--body",on:c},r),!1===o.isFooter?null:n("div",{class:"vxe-custom--footer"},[n("button",{class:"btn--confirm",on:{click:l.confirmCustomEvent}},_conf.default.i18n("vxe.toolbar.customConfirm")),n("button",{class:"btn--reset",on:{click:l.resetCustomEvent}},_conf.default.i18n("vxe.toolbar.customRestore"))])])])}var _default2={name:"VxeToolbar",props:{id:String,loading:Boolean,resizable:[Boolean,Object],refresh:[Boolean,Object],import:[Boolean,Object],export:[Boolean,Object],zoom:[Boolean,Object],setting:[Boolean,Object],custom:[Boolean,Object],buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},perfect:{type:Boolean,default:function(){return _conf.default.toolbar.perfect}},size:{type:String,default:function(){return _conf.default.toolbar.size||_conf.default.size}}},inject:{$xegrid:{default:null}},data:function(){return{$xetable:null,isRefresh:!1,collectColumn:[],customStore:{isAll:!1,isIndeterminate:!1,visible:!1}}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},importOpts:function(){return Object.assign({},_conf.default.toolbar.import,this.import)},exportOpts:function(){return Object.assign({},_conf.default.toolbar.export,this.export)},resizableOpts:function(){return Object.assign({},_conf.default.toolbar.resizable,this.resizable)},zoomOpts:function(){return Object.assign({},_conf.default.toolbar.zoom,this.zoom)},customOpts:function(){return Object.assign({},_conf.default.toolbar.custom,this.custom)}},created:function(){var e=this,t=this.customOpts,o=this.refresh,s=this.resizable,i=this.setting,n=this.id,l=this.refreshOpts;if(t.storage&&!n)return _tools.UtilTools.error("vxe.error.reqProp",["toolbar.id"]);n&&_tools.UtilTools.warn("vxe.error.removeProp",["toolbar.id"]),i&&_tools.UtilTools.warn("vxe.error.delProp",["toolbar.setting","toolbar.custom"]),_vXETable.default._export||!this.export&&!this.import||_tools.UtilTools.error("vxe.error.reqModule",["Export"]),s&&_tools.UtilTools.warn("vxe.error.delProp",["toolbar.resizable","custom-config.storage"]),t.storage&&_tools.UtilTools.warn("vxe.error.delProp",["toolbar.custom.storage","custom-config.storage"]),this.$nextTick(function(){var t=e.fintTable();!o||e.$xegrid||l.query||_tools.UtilTools.warn("vxe.error.notFunc",["query"]),t&&t.connect(e)}),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(t){var e,o=this.$xegrid,s=this.perfect,i=this.loading,n=this.importOpts,l=this.exportOpts,r=this.refresh,c=this.refreshOpts,a=this.zoom,u=this.zoomOpts,h=this.custom,f=this.setting,v=this.vSize;return t("div",{class:["vxe-toolbar",(_defineProperty(e={},"size--".concat(v),v),_defineProperty(e,"is--perfect",s),_defineProperty(e,"is--loading",i),e)]},[t("div",{class:"vxe-button--wrapper"},renderBtns(t,this)),t("div",{class:"vxe-tools--wrapper"},renderRightTools(t,this)),t("div",{class:"vxe-tools--operate"},[this.import?t("div",{class:"vxe-tools--operate-btn vxe-tools--operate-import-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.import")},on:{click:this.importEvent}},[t("i",{class:n.icon||_conf.default.icon.TOOLBAR_TOOLS_IMPORT})]):null,this.export?t("div",{class:"vxe-tools--operate-btn vxe-tools--operate-export-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.export")},on:{click:this.exportEvent}},[t("i",{class:l.icon||_conf.default.icon.TOOLBAR_TOOLS_EXPORT})]):null,r?t("div",{class:"vxe-tools--operate-btn vxe-tools--operate-refresh-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.refresh")},on:{click:this.refreshEvent}},[t("i",{class:this.isRefresh?c.iconLoading||_conf.default.icon.TOOLBAR_TOOLS_REFRESH_LOADING:c.icon||_conf.default.icon.TOOLBAR_TOOLS_REFRESH})]):null,a&&o?t("div",{class:"vxe-tools--operate-btn vxe-tools--operate-zoom-btn",attrs:{title:_conf.default.i18n("vxe.toolbar.zoom".concat(o.isMaximized()?"Out":"In"))},on:{click:o.triggerZoomEvent}},[t("i",{class:o.isMaximized()?u.iconOut||_conf.default.icon.TOOLBAR_TOOLS_ZOOM_OUT:u.iconIn||_conf.default.icon.TOOLBAR_TOOLS_ZOOM_IN})]):null,h||f?renderCustoms(t,this):null])])},methods:{syncUpdate:function(t){var e=t.collectColumn,o=t.$table;this.$xetable=o,this.collectColumn=e},fintTable:function(){var t=this.$parent.$children,o=t.indexOf(this);return _xeUtils.default.find(t,function(t,e){return t&&t.refreshColumn&&o<e&&"vxe-table"===t.$vnode.componentOptions.tag})},checkTable:function(){if(this.$xetable)return!0;_tools.UtilTools.error("vxe.error.barUnableLink")},showCustom:function(){this.customStore.visible=!0,this.checkCustomStatus()},closeCustom:function(){var t=this.custom,e=this.setting,o=this.customStore;o.visible&&(o.visible=!1,!t&&!e||o.immediate||this.handleCustoms())},confirmCustomEvent:function(t){this.closeCustom(),this.emitCustomEvent("confirm",t)},customOpenEvent:function(t){var e=this.customStore;this.checkTable()&&(e.visible||(this.showCustom(),this.emitCustomEvent("open",t)))},customColseEvent:function(t){this.customStore.visible&&(this.closeCustom(),this.emitCustomEvent("close",t))},resetCustomEvent:function(t){var e=this.$xetable,o=this.collectColumn,s=this.customOpts,i=e.customOpts.checkMethod||s.checkMethod;_xeUtils.default.eachTree(o,function(t){i&&!i({column:t})||(t.visible=t.defaultVisible,t.halfVisible=!1),t.resizeWidth=0}),e.saveCustomResizable(!0),this.closeCustom(),this.emitCustomEvent("reset",t)},emitCustomEvent:function(t,e){var o=this.$xetable,s=this.$xegrid;(s||o).$emit("custom",{type:t,$table:o,$grid:s,$event:e},e)},changeCustomOption:function(t){var e=!t.visible;_xeUtils.default.eachTree([t],function(t){t.visible=e,t.halfVisible=!1}),this.handleOptionCheck(t),this.custom&&this.customOpts.immediate&&this.handleCustoms(),this.checkCustomStatus()},handleOptionCheck:function(e){var t=_xeUtils.default.findTree(this.collectColumn,function(t){return t===e});if(t&&t.parent){var o=t.parent;o.children&&o.children.length&&(o.visible=o.children.every(function(t){return t.visible}),o.halfVisible=!o.visible&&o.children.some(function(t){return t.visible||t.halfVisible}),this.handleOptionCheck(o))}},handleCustoms:function(){var t=this.$xetable;t.saveCustomVisible(),t.analyColumnWidth(),t.refreshColumn()},checkCustomStatus:function(){var t=this.$xetable,e=this.collectColumn,o=this.customOpts,s=t.customOpts.checkMethod||o.checkMethod;this.customStore.isAll=e.every(function(t){return!!s&&!s({column:t})||t.visible}),this.customStore.isIndeterminate=!this.customStore.isAll&&e.some(function(t){return(!s||s({column:t}))&&(t.visible||t.halfVisible)})},allCustomEvent:function(){var t=this.$xetable,e=this.collectColumn,o=this.customOpts,s=this.customStore,i=t.customOpts.checkMethod||o.checkMethod,n=!s.isAll;_xeUtils.default.eachTree(e,function(t){i&&!i({column:t})||(t.visible=n,t.halfVisible=!1)}),s.isAll=n,this.checkCustomStatus()},handleGlobalMousedownEvent:function(t){_tools.DomTools.getEventTargetNode(t,this.$refs.customWrapper).flag||this.customColseEvent(t)},handleGlobalBlurEvent:function(t){this.customColseEvent(t)},handleClickSettingEvent:function(t){this.customStore.visible?this.customColseEvent(t):this.customOpenEvent(t)},handleMouseenterSettingEvent:function(t){this.customStore.activeBtn=!0,this.customOpenEvent(t)},handleMouseleaveSettingEvent:function(t){var e=this,o=this.customStore;o.activeBtn=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||e.customColseEvent(t)},300)},handleWrapperMouseenterEvent:function(t){this.customStore.activeWrapper=!0,this.customOpenEvent(t)},handleWrapperMouseleaveEvent:function(t){var e=this,o=this.customStore;o.activeWrapper=!1,setTimeout(function(){o.activeBtn||o.activeWrapper||e.customColseEvent(t)},300)},refreshEvent:function(){var t=this,e=this.$xegrid,o=this.refreshOpts;if(!this.isRefresh)if(o.query){this.isRefresh=!0;try{Promise.resolve(o.query()).catch(function(t){return t}).then(function(){t.isRefresh=!1})}catch(t){this.isRefresh=!1}}else e&&(this.isRefresh=!0,e.commitProxy("reload").catch(function(t){return t}).then(function(){t.isRefresh=!1}))},btnEvent:function(t,e){var o=this.$xegrid,s=this.$xetable,i=e.code;if(i)if(o)o.triggerToolbarBtnEvent(e,t);else{var n=_vXETable.default.commands.get(i),l={code:i,button:e,$xegrid:o,$table:s,$event:t};n&&n.call(this,l,t),this.$emit("button-click",l,t)}},importEvent:function(){this.checkTable()&&this.$xetable.openImport(this.importOpts)},exportEvent:function(){this.checkTable()&&this.$xetable.openExport(this.exportOpts)}}};exports.default=_default2;